<!DOCTYPE html>
<html lang="tr">
<head>
    <!--
        ========================================================
        INDİRİM RADARI V1
        Steam + Epic Games indirimlerini takip eden deneysel sayfa
        Siyah-beyaz, garip ve biraz “glitchy” tasarım
        Notepad dostu tek dosyalık web uygulaması
        ========================================================
    -->
    <meta charset="UTF-8">
    <title>İndirim Radarı - Steam & Epic</title>

    <style>
        /* ======================================================
           GENEL TEMA
           Siyah arka plan, beyaz metin, bol sınır, garip geometriler
           ====================================================== */

        :root {
            --bg-main: #000000;
            --fg-main: #f5f5f5;
            --fg-muted: #bbbbbb;
            --accent: #ffffff;
            --border-soft: #333333;
            --accent-strong: #ffffff;
            --error: #ff5555;
            --success: #55ff55;
            --warning: #ffff55;

            --font-main: "Consolas", "Fira Code", "Courier New", monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            background-color: var(--bg-main);
            color: var(--fg-main);
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: stretch;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ana konteyner */
        .app {
            width: 100%;
            max-width: 1400px;
            min-height: 100vh;
            padding: 20px 16px 40px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            border-left: 2px dashed var(--accent);
            border-right: 2px dashed var(--accent);
            position: relative;
        }

        /* Arka plan çizgileri (garip grid) */
        .app::before,
        .app::after {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: 0.07;
            background-image:
                linear-gradient(to right, #ffffff11 1px, transparent 1px),
                linear-gradient(to bottom, #ffffff11 1px, transparent 1px);
            background-size: 32px 32px;
            mix-blend-mode: screen;
            z-index: -1;
        }

        /* HEADER ================================================= */

        header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 10px;
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .title-block {
            display: inline-flex;
            flex-direction: column;
            gap: 4px;
        }

        .logo-text {
            font-size: 24px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 700;
            padding: 4px 8px;
            border: 1px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .logo-text span.shadow {
            position: absolute;
            inset: 0;
            left: 2px;
            top: 2px;
            color: transparent;
            text-shadow:
                -1px 0 0 #ffffff,
                1px 0 0 #ffffff,
                0 -1px 0 #ffffff,
                0 1px 0 #ffffff;
            opacity: 0.15;
            pointer-events: none;
        }

        .logo-text span.main {
            position: relative;
            z-index: 2;
        }

        .subtitle {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--fg-muted);
        }

        .status-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            font-size: 11px;
        }

        .status-chip {
            border: 1px solid var(--border-soft);
            padding: 4px 8px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .status-chip.online {
            border-style: dashed;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            margin-right: 6px;
            display: inline-block;
            background-color: var(--success);
            box-shadow: 0 0 6px #55ff5555;
        }

        .status-dot.offline {
            background-color: var(--error);
            box-shadow: 0 0 4px #ff555555;
        }

        .time-chip {
            border: 1px solid var(--border-soft);
            padding: 4px 8px;
            text-align: right;
            flex-grow: 1;
        }

        /* KONTROL PANELİ ========================================= */

        .control-panel {
            display: grid;
            grid-template-columns: repeat(4, minmax(160px, 1fr));
            gap: 10px;
            font-size: 11px;
        }

        @media (max-width: 900px) {
            .control-panel {
                grid-template-columns: repeat(2, minmax(150px, 1fr));
            }
        }

        @media (max-width: 600px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
        }

        .control-card {
            border: 1px solid var(--border-soft);
            padding: 8px;
            position: relative;
            overflow: hidden;
        }

        .control-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: linear-gradient(
                135deg,
                transparent 0,
                transparent 60%,
                #ffffff0a 61%,
                transparent 62%
            );
            mix-blend-mode: screen;
            opacity: 0.7;
            pointer-events: none;
        }

        .control-title {
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .control-body {
            font-size: 11px;
            color: var(--fg-muted);
        }

        .control-body strong {
            color: var(--fg-main);
        }

        .toggle-row {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .toggle-btn {
            flex: 1;
            border: 1px solid var(--border-soft);
            padding: 4px;
            text-align: center;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.12em;
            background: transparent;
            color: var(--fg-main);
        }

        .toggle-btn.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px var(--accent);
        }

        .slider-input {
            width: 100%;
            margin-top: 4px;
            accent-color: #ffffff;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            text-transform: uppercase;
        }

        button.plain-btn {
            border: 1px solid var(--border-soft);
            background: transparent;
            color: var(--fg-main);
            text-transform: uppercase;
            letter-spacing: 0.16em;
            font-size: 10px;
            padding: 6px 8px;
            cursor: pointer;
            width: 100%;
        }

        button.plain-btn:hover {
            border-style: dashed;
        }

        /* ANA İÇERİK LAYOUT ===================================== */

        .content {
            display: grid;
            grid-template-columns: 2fr 2fr 1.2fr;
            gap: 14px;
            margin-top: 12px;
        }

        @media (max-width: 1100px) {
            .content {
                grid-template-columns: 1.5fr 1.5fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            border: 1px solid var(--border-soft);
            padding: 10px;
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .panel::before {
            content: attr(data-label);
            position: absolute;
            top: -1px;
            left: 10px;
            padding: 0 4px;
            background-color: var(--bg-main);
            font-size: 9px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--fg-muted);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 6px;
        }

        .panel-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
        }

        .panel-meta {
            font-size: 10px;
            color: var(--fg-muted);
        }

        .panel-meta span {
            display: inline-block;
            margin-left: 6px;
        }

        /* LİSTE TASARIMI ======================================== */

        .deal-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px;
            margin-top: 4px;
        }

        .deal-item {
            border: 1px solid var(--border-soft);
            padding: 6px;
            display: grid;
            grid-template-columns: 1.5fr 0.6fr 0.6fr 0.8fr;
            gap: 4px;
            align-items: center;
            font-size: 11px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .deal-item::before {
            content: "";
            position: absolute;
            inset: 0;
            opacity: 0;
            background-image: repeating-linear-gradient(
                135deg,
                #ffffff0f 0,
                #ffffff0f 1px,
                transparent 1px,
                transparent 2px
            );
            mix-blend-mode: screen;
            pointer-events: none;
            transition: opacity 0.12s linear;
        }

        .deal-item:hover::before {
            opacity: 1;
        }

        .deal-item:hover {
            border-style: dashed;
        }

        .deal-item-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .deal-name {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .deal-platform-tag {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--fg-muted);
        }

        .deal-discount {
            text-align: right;
            font-size: 12px;
        }

        .deal-price-old {
            text-decoration: line-through;
            color: var(--fg-muted);
            font-size: 10px;
            text-align: right;
        }

        .deal-price-new {
            text-align: right;
            font-weight: 600;
        }

        .deal-score {
            text-align: right;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .deal-score span {
            display: block;
        }

        .deal-score .score-label {
            color: var(--fg-muted);
        }

        .deal-score .score-value {
            font-size: 12px;
        }

        .deal-item.top-deal {
            border-color: var(--accent-strong);
            box-shadow: 0 0 0 1px var(--accent-strong);
        }

        /* YAN PANEL - ÖZET & GEÇMİŞ ============================ */

        .summary-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 11px;
        }

        .summary-block {
            border: 1px solid var(--border-soft);
            padding: 8px;
            position: relative;
            overflow: hidden;
        }

        .summary-block-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            margin-bottom: 4px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
        }

        .summary-label {
            color: var(--fg-muted);
        }

        .summary-value {
            text-align: right;
        }

        .history-list {
            max-height: 260px;
            overflow-y: auto;
            margin-top: 4px;
            border-top: 1px dashed var(--border-soft);
            padding-top: 4px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            border-bottom: 1px dotted var(--border-soft);
            padding: 4px 0;
            gap: 2px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-main {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
        }

        .history-meta {
            font-size: 9px;
            color: var(--fg-muted);
            display: flex;
            justify-content: space-between;
        }

        /* BİLDİRİM (TOAST) SİSTEMİ ============================= */

        .toast-container {
            position: fixed;
            bottom: 16px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 340px;
            z-index: 999;
        }

        .toast {
            border: 1px solid var(--accent);
            padding: 8px;
            background-color: #000000dd;
            font-size: 11px;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(
                0deg,
                #ffffff0f 0,
                #ffffff0f 1px,
                transparent 1px,
                transparent 2px
            );
            mix-blend-mode: screen;
            opacity: 0.7;
            pointer-events: none;
        }

        .toast-title {
            text-transform: uppercase;
            letter-spacing: 0.16em;
            margin-bottom: 4px;
        }

        .toast-body {
            color: var(--fg-muted);
        }

        /* GLITCH ANİMASYONU (başlık için ufak titreşim) ======== */

        @keyframes glitch {
            0% { transform: translate(0,0); }
            20% { transform: translate(-1px, 0); }
            25% { transform: translate(1px, 0); }
            30% { transform: translate(0, 1px); }
            35% { transform: translate(0, -1px); }
            40% { transform: translate(0, 0); }
            100% { transform: translate(0, 0); }
        }

        .logo-text {
            animation: glitch 4s infinite steps(2, end);
        }

        /* scrollbar biraz minimal */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #050505;
        }
        ::-webkit-scrollbar-thumb {
            background: #ffffff33;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ffffff66;
        }
    </style>
</head>
<body>

<div class="app" id="app-root">

    <!-- =====================================================
         HEADER
         ===================================================== -->
    <header>
        <div class="title-row">
            <div class="title-block">
                <div class="logo-text">
                    <span class="shadow">INDIRIM RADARI</span>
                    <span class="main">INDIRIM&nbsp;RADARI</span>
                </div>
                <div class="subtitle">
                    steam / epic &mdash; gerçek zamanlı indirim tarayıcı
                </div>
            </div>

            <div class="status-row">
                <div class="status-chip" id="connection-status">
                    <span class="status-dot offline" id="status-dot"></span>
                    <span id="status-text">beklemede</span>
                </div>
                <div class="status-chip online" id="notification-status">
                    BİLDİRİM: <span id="notification-text">PASİF</span>
                </div>
                <div class="time-chip">
                    <span>SON TARANMA:</span>
                    <span id="last-update">-</span>
                </div>
            </div>
        </div>

        <!-- KONTROL PANELİ -->
        <div class="control-panel">
            <!-- Platform filtreleri -->
            <div class="control-card">
                <div class="control-title">PLATFORM FİLTRESİ</div>
                <div class="control-body">
                    Hangi mağazaları izleyeceğini seç.
                    <div class="toggle-row">
                        <button class="toggle-btn active" id="toggle-steam">STEAM</button>
                        <button class="toggle-btn active" id="toggle-epic">EPIC</button>
                    </div>
                </div>
            </div>

            <!-- Minimum indirim -->
            <div class="control-card">
                <div class="control-title">MİN. İNDİRİM</div>
                <div class="control-body">
                    <div class="slider-label">
                        <span id="min-discount-label">En az: 0%</span>
                        <span>100%</span>
                    </div>
                    <input
                        type="range"
                        min="0"
                        max="100"
                        value="0"
                        id="min-discount-slider"
                        class="slider-input"
                    />
                    <div style="margin-top:4px;">
                        Altındaki indirimler listeden gizlenir.
                    </div>
                </div>
            </div>

            <!-- Yenileme aralığı -->
            <div class="control-card">
                <div class="control-title">YENİLEME ARALIĞI</div>
                <div class="control-body">
                    <div class="slider-label">
                        <span id="refresh-interval-label">60 sn</span>
                        <span>600 sn</span>
                    </div>
                    <input
                        type="range"
                        min="30"
                        max="600"
                        value="300"
                        step="30"
                        id="refresh-interval-slider"
                        class="slider-input"
                    />
                    <div style="margin-top:4px;">
                        Otomatik tarama süresi (saniye).
                    </div>
                </div>
            </div>

            <!-- Manuel tetikleme -->
            <div class="control-card">
                <div class="control-title">KONTROL</div>
                <div class="control-body">
                    <button class="plain-btn" id="btn-refresh-now">
                        ŞİMDİ TARA
                    </button>
                    <div style="margin-top:4px;">
                        Son büyük indirimi yakalamak için manuel tetikleyici.
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- =====================================================
         MAIN CONTENT
         ===================================================== -->
    <main class="content">
        <!-- Steam -->
        <section class="panel" data-label="steam / mağaza" id="panel-steam">
            <div class="panel-header">
                <div class="panel-title">Steam İndirimleri</div>
                <div class="panel-meta">
                    <span id="steam-count">0 oyun</span>
                    <span id="steam-meta-extra">en yüksek: -</span>
                </div>
            </div>
            <div class="deal-list" id="steam-deal-list">
                <!-- JS ile doldurulacak -->
            </div>
        </section>

        <!-- Epic -->
        <section class="panel" data-label="epic / mağaza" id="panel-epic">
            <div class="panel-header">
                <div class="panel-title">Epic Games İndirimleri</div>
                <div class="panel-meta">
                    <span id="epic-count">0 oyun</span>
                    <span id="epic-meta-extra">en yüksek: -</span>
                </div>
            </div>
            <div class="deal-list" id="epic-deal-list">
                <!-- JS ile doldurulacak -->
            </div>
        </section>

        <!-- YAN PANEL -->
        <aside class="panel" data-label="özet / geçmiş">
            <div class="panel-header">
                <div class="panel-title">Radar Özeti</div>
                <div class="panel-meta">
                    <span id="scan-count">0 tarama</span>
                </div>
            </div>

            <div class="summary-section">
                <!-- ÖZET -->
                <div class="summary-block" id="summary-overall">
                    <div class="summary-block-title">Anlık Özet</div>
                    <div class="summary-row">
                        <div class="summary-label">Toplam oyun</div>
                        <div class="summary-value" id="summary-total-games">0</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">En yüksek indirim</div>
                        <div class="summary-value" id="summary-best-discount">-</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-label">En son değişen</div>
                        <div class="summary-value" id="summary-last-changed">-</div>
                    </div>
                </div>

                <!-- TOP İNDİRİMLER -->
                <div class="summary-block">
                    <div class="summary-block-title">Şu Anın En Çılgın İndirimi</div>
                    <div id="top-deal-highlight" style="font-size:11px;">
                        henüz veri yok.
                    </div>
                </div>

                <!-- TARİHÇE -->
                <div class="summary-block">
                    <div class="summary-block-title">Tarihçe (Büyük İndirimler)</div>
                    <div class="history-list" id="history-list">
                        <!-- JS ile doldurulacak -->
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Toast konteyner -->
    <div class="toast-container" id="toast-container"></div>
</div>

<!-- =========================================================
     JAVASCRIPT BAŞLANGIÇ
     ========================================================= -->
<script>
    // =========================================================
    // Yardımcı fonksiyonlar ve tipler
    // =========================================================

    /**
     * Basit log fonksiyonu - konsola yazarken prefix ekler
     * @param {string} level - 'info', 'warn', 'error'
     * @param {...any} args
     */
    function log(level, ...args) {
        const prefix = "[INDIRIM-RADARI]";
        const time = new Date().toISOString().split("T")[1].split(".")[0];
        console[level](`${prefix} [${time}]`, ...args);
    }

    /**
     * Zamanı HH:MM:SS formatında döndür
     */
    function formatTime(date) {
        const d = date instanceof Date ? date : new Date(date);
        const h = String(d.getHours()).padStart(2, "0");
        const m = String(d.getMinutes()).padStart(2, "0");
        const s = String(d.getSeconds()).padStart(2, "0");
        return `${h}:${m}:${s}`;
    }

    /**
     * TL fiyat format
     */
    function formatPriceTRY(value) {
        if (value == null || isNaN(value)) return "-";
        return value.toLocaleString("tr-TR", {
            style: "currency",
            currency: "TRY",
            maximumFractionDigits: 2
        });
    }

    /**
     * İndirim yüzdesi format
     */
    function formatDiscount(percent) {
        if (percent == null || isNaN(percent)) return "-";
        return `-${percent}%`;
    }

    /**
     * Rastgele ID üret (tarihçe vs için)
     */
    function randomId() {
        return Math.random().toString(36).substring(2, 10);
    }

    // =========================================================
    // Uygulama durumu
    // =========================================================

    const state = {
        settings: {
            platformSteam: true,
            platformEpic: true,
            minDiscount: 0,
            refreshIntervalSec: 300,
        },
        data: {
            steamDeals: [],
            epicDeals: [],
        },
        meta: {
            lastUpdate: null,
            scanCount: 0,
            lastTopDealId: null,
            history: []
        },
        timers: {
            refreshIntervalId: null
        }
    };

    // =========================================================
    // DOM Referansları
    // =========================================================

    const elStatusDot = document.getElementById("status-dot");
    const elStatusText = document.getElementById("status-text");
    const elNotificationStatus = document.getElementById("notification-status");
    const elNotificationText = document.getElementById("notification-text");
    const elLastUpdate = document.getElementById("last-update");

    const elToggleSteam = document.getElementById("toggle-steam");
    const elToggleEpic = document.getElementById("toggle-epic");
    const elMinDiscountSlider = document.getElementById("min-discount-slider");
    const elMinDiscountLabel = document.getElementById("min-discount-label");
    const elRefreshIntervalSlider = document.getElementById("refresh-interval-slider");
    const elRefreshIntervalLabel = document.getElementById("refresh-interval-label");
    const elBtnRefreshNow = document.getElementById("btn-refresh-now");

    const elSteamList = document.getElementById("steam-deal-list");
    const elEpicList = document.getElementById("epic-deal-list");
    const elSteamCount = document.getElementById("steam-count");
    const elSteamMetaExtra = document.getElementById("steam-meta-extra");
    const elEpicCount = document.getElementById("epic-count");
    const elEpicMetaExtra = document.getElementById("epic-meta-extra");

    const elScanCount = document.getElementById("scan-count");
    const elSummaryTotalGames = document.getElementById("summary-total-games");
    const elSummaryBestDiscount = document.getElementById("summary-best-discount");
    const elSummaryLastChanged = document.getElementById("summary-last-changed");
    const elTopDealHighlight = document.getElementById("top-deal-highlight");
    const elHistoryList = document.getElementById("history-list");
    const elToastContainer = document.getElementById("toast-container");

    // =========================================================
    // Bildirim (Toast) sistemi
    // =========================================================

    /**
     * Basit toast bildirimi
     * @param {string} title
     * @param {string} message
     * @param {number} timeoutMs
     */
    function showToast(title, message, timeoutMs = 6000) {
        const toast = document.createElement("div");
        toast.className = "toast";

        const titleEl = document.createElement("div");
        titleEl.className = "toast-title";
        titleEl.textContent = title;

        const bodyEl = document.createElement("div");
        bodyEl.className = "toast-body";
        bodyEl.textContent = message;

        toast.appendChild(titleEl);
        toast.appendChild(bodyEl);

        elToastContainer.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(4px)";
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, timeoutMs);
    }

    // =========================================================
    // Web Notification API entegrasyonu (isteğe bağlı)
    // =========================================================

    /**
     * Tarayıcı bildirim izni iste
     */
    function ensureNotificationPermission() {
        if (!("Notification" in window)) {
            elNotificationText.textContent = "DESTEKLENMİYOR";
            return;
        }

        if (Notification.permission === "granted") {
            elNotificationText.textContent = "AKTİF";
            return;
        }

        if (Notification.permission !== "denied") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    elNotificationText.textContent = "AKTİF";
                    showToast("bildirim izin verildi", "Yeni büyük indirimlerde masaüstü bildirimi görebilirsin.");
                } else {
                    elNotificationText.textContent = "PASİF";
                }
            });
        } else {
            elNotificationText.textContent = "PASİF";
        }
    }

    /**
     * Masaüstü bildirimi gönder
     */
    function sendDesktopNotification(title, body) {
        if (!("Notification" in window)) return;
        if (Notification.permission !== "granted") return;

        const notif = new Notification(title, {
            body,
            icon: "" // istersen buraya siyah-beyaz ikon ekleyebilirsin
        });

        setTimeout(() => notif.close(), 8000);
    }

    // =========================================================
    // Mock veri (API çalışmazsa)
    // =========================================================

    const MOCK_STEAM_DEALS = [
        {
            id: "mock-steam-1",
            name: "EFSANE FANTASTİK RPG",
            platform: "STEAM",
            discountPercent: 90,
            oldPrice: 599.00,
            newPrice: 59.90,
            score: 9.1,
            url: "https://store.steampowered.com/",
        },
        {
            id: "mock-steam-2",
            name: "UZAY TAKTİK SİMÜLATÖRÜ",
            platform: "STEAM",
            discountPercent: 80,
            oldPrice: 199.00,
            newPrice: 39.80,
            score: 8.4,
            url: "https://store.steampowered.com/",
        },
        {
            id: "mock-steam-3",
            name: "PİXEL ROGUELIKE KABUSU",
            platform: "STEAM",
            discountPercent: 75,
            oldPrice: 99.00,
            newPrice: 24.75,
            score: 8.9,
            url: "https://store.steampowered.com/",
        }
    ];

    const MOCK_EPIC_DEALS = [
        {
            id: "mock-epic-1",
            name: "SİBERPUNK HACKER MACERASI",
            platform: "EPIC",
            discountPercent: 85,
            oldPrice: 499.00,
            newPrice: 74.85,
            score: 8.8,
            url: "https://store.epicgames.com/",
        },
        {
            id: "mock-epic-2",
            name: "FİZİK TABANLI GÜLMECE",
            platform: "EPIC",
            discountPercent: 70,
            oldPrice: 149.00,
            newPrice: 44.70,
            score: 7.9,
            url: "https://store.epicgames.com/",
        },
        {
            id: "mock-epic-3",
            name: "KARANLIK METROİDVANYA",
            platform: "EPIC",
            discountPercent: 60,
            oldPrice: 129.00,
            newPrice: 51.60,
            score: 9.0,
            url: "https://store.epicgames.com/",
        }
    ];

    // =========================================================
    // Steam API TARAYICI
    // =========================================================

    /**
     * Steam indirimlerini çek (deneysel)
     * Gerçek API CORS engellerse mock veriye düşer
     */
    async function fetchSteamDeals() {
        const API_URL = "https://store.steampowered.com/api/featuredcategories/?l=turkish";
        try {
            log("info", "Steam verisi çekiliyor...");

            const res = await fetch(API_URL, { cache: "no-store" });

            if (!res.ok) {
                throw new Error("HTTP " + res.status);
            }

            const json = await res.json();

            // 'specials' kategorisi içinde indirimler var
            const specials = json.specials || {};
            const items = specials.items || [];

            const deals = items.map((item, index) => {
                const discountPercent = item.discount_percent || 0;
                const oldPrice = (item.original_price || 0) / 100;
                const newPrice = (item.final_price || 0) / 100;
                return {
                    id: "steam-" + (item.id || item.name || index),
                    name: item.name || "Bilinmeyen Steam Oyunu",
                    platform: "STEAM",
                    discountPercent,
                    oldPrice,
                    newPrice,
                    score: null, // steam api doğrudan vermiyor
                    url: item.large_capsule_image
                        ? "https://store.steampowered.com/app/" + item.id
                        : "https://store.steampowered.com/",
                };
            });

            // İndirim yüzdesine göre sırala
            deals.sort((a, b) => b.discountPercent - a.discountPercent);

            log("info", `Steam verisi çekildi (${deals.length} oyun)`);
            return deals;
        } catch (err) {
            log("warn", "Steam API başarısız, mock veriye düşüldü:", err);
            return MOCK_STEAM_DEALS;
        }
    }

    // =========================================================
    // Epic Games API TARAYICI
    // =========================================================

    /**
     * Epic indirimlerini çek (deneysel)
     * CORS engellerse mock veriye düşer
     */
    async function fetchEpicDeals() {
        const API_URL =
            "https://store-site-backend-static.ak.epicgames.com/freeGamesPromotions?locale=tr-TR&country=TR&allowCountries=TR";

        try {
            log("info", "Epic verisi çekiliyor...");

            const res = await fetch(API_URL, { cache: "no-store" });

            if (!res.ok) {
                throw new Error("HTTP " + res.status);
            }

            const json = await res.json();
            const data = json.data || json;
            const catalog = data.Catalog || {};
            const searchStore = catalog.searchStore || {};
            const elements = searchStore.elements || [];

            const deals = [];

            elements.forEach((el, index) => {
                const priceInfo = (el.price && el.price.totalPrice) || null;
                if (!priceInfo) return;

                const original = priceInfo.originalPrice || 0;
                const discount = priceInfo.discount || 0;
                const final = priceInfo.discountPrice || 0;

                let discountPercent = 0;
                if (original > 0) {
                    discountPercent = Math.round((discount / original) * 100);
                }

                if (discountPercent <= 0) return;

                deals.push({
                    id: "epic-" + (el.id || el.title || index),
                    name: el.title || "Bilinmeyen Epic Oyunu",
                    platform: "EPIC",
                    discountPercent,
                    oldPrice: original / 100,
                    newPrice: final / 100,
                    score: null,
                    url: `https://store.epicgames.com/tr/p/${(el.productSlug || "").replace(
                        "/home",
                        ""
                    )}`,
                });
            });

            deals.sort((a, b) => b.discountPercent - a.discountPercent);

            log("info", `Epic verisi çekildi (${deals.length} oyun)`);
            return deals.length ? deals : MOCK_EPIC_DEALS;
        } catch (err) {
            log("warn", "Epic API başarısız, mock veriye düşüldü:", err);
            return MOCK_EPIC_DEALS;
        }
    }

    // =========================================================
    // Liste render fonksiyonları
    // =========================================================

    /**
     * Tekil deal item DOM'u oluştur
     */
    function renderDealItem(deal, isTop = false) {
        const item = document.createElement("div");
        item.className = "deal-item";
        if (isTop) {
            item.classList.add("top-deal");
        }

        // Başlık
        const titleCol = document.createElement("div");
        titleCol.className = "deal-item-title";

        const nameEl = document.createElement("div");
        nameEl.className = "deal-name";
        nameEl.textContent = deal.name;

        const platformEl = document.createElement("div");
        platformEl.className = "deal-platform-tag";
        platformEl.textContent = deal.platform === "STEAM" ? "STEAM / PC" : "EPIC / PC";

        titleCol.appendChild(nameEl);
        titleCol.appendChild(platformEl);

        // İndirim yüzdesi
        const discountCol = document.createElement("div");
        discountCol.className = "deal-discount";
        discountCol.textContent = formatDiscount(deal.discountPercent);

        // Fiyatlar
        const priceCol = document.createElement("div");

        const oldPriceEl = document.createElement("div");
        oldPriceEl.className = "deal-price-old";
        oldPriceEl.textContent = formatPriceTRY(deal.oldPrice);

        const newPriceEl = document.createElement("div");
        newPriceEl.className = "deal-price-new";
        newPriceEl.textContent = formatPriceTRY(deal.newPrice);

        priceCol.appendChild(oldPriceEl);
        priceCol.appendChild(newPriceEl);

        // Skor / ID
        const scoreCol = document.createElement("div");
        scoreCol.className = "deal-score";

        const labelEl = document.createElement("span");
        labelEl.className = "score-label";
        labelEl.textContent = "RADAR-SCORE";

        const valueEl = document.createElement("span");
        valueEl.className = "score-value";

        // Basit skor: indirim + (puan varsa)
        const baseScore = deal.discountPercent;
        const metaScore = deal.score != null ? deal.score : 0;
        const finalScore = Math.round(baseScore + metaScore * 2);
        valueEl.textContent = finalScore;

        scoreCol.appendChild(labelEl);
        scoreCol.appendChild(valueEl);

        // Tüm kolonları item'a ekle
        item.appendChild(titleCol);
        item.appendChild(discountCol);
        item.appendChild(priceCol);
        item.appendChild(scoreCol);

        // Tıklama -> mağaza sayfası
        item.addEventListener("click", () => {
            if (deal.url) {
                window.open(deal.url, "_blank");
            }
        });

        return item;
    }

    /**
     * Belirli bir listeyi doldur
     */
    function renderDealList(containerEl, deals, topDealId) {
        containerEl.innerHTML = "";
        deals.forEach((deal, index) => {
            const isTop = deal.id === topDealId && index === 0;
            const itemEl = renderDealItem(deal, isTop);
            containerEl.appendChild(itemEl);
        });
    }

    /**
     * Özet ve tarihçeyi güncelle
     */
    function updateSummaryAndHistory() {
        const steamDeals = state.data.steamDeals;
        const epicDeals = state.data.epicDeals;

        const allDeals = [...steamDeals, ...epicDeals];

        const totalGames = allDeals.length;
        elSummaryTotalGames.textContent = totalGames;

        if (totalGames === 0) {
            elSummaryBestDiscount.textContent = "-";
            elTopDealHighlight.textContent = "henüz veri yok.";
            return;
        }

        // En yüksek indirim
        const sortedByDiscount = allDeals.slice().sort((a, b) => b.discountPercent - a.discountPercent);
        const best = sortedByDiscount[0];

        elSummaryBestDiscount.textContent = `${formatDiscount(best.discountPercent)} (${best.name})`;

        // Highlight
        elTopDealHighlight.innerHTML = `
            <div style="text-transform:uppercase; letter-spacing:0.08em; margin-bottom:2px;">
                ${best.platform} / ${best.name}
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>İndirim</span>
                <span>${formatDiscount(best.discountPercent)}</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>Fiyat</span>
                <span>${formatPriceTRY(best.newPrice)} (önce: ${formatPriceTRY(best.oldPrice)})</span>
            </div>
        `;

        // Tarihçeye ekle (sadece yeni top değiştiyse)
        if (state.meta.lastTopDealId !== best.id) {
            state.meta.lastTopDealId = best.id;
            const now = new Date();

            state.meta.history.unshift({
                id: randomId(),
                dealId: best.id,
                name: best.name,
                platform: best.platform,
                discountPercent: best.discountPercent,
                price: best.newPrice,
                time: now
            });

            // 20 kayıttan fazlasını tutma
            if (state.meta.history.length > 20) {
                state.meta.history.length = 20;
            }

            elSummaryLastChanged.textContent = formatTime(now);

            // Bildirim & toast
            const title = "YENİ TOP İNDİRİM";
            const msg = `${best.platform}: ${best.name} şu an ${formatDiscount(best.discountPercent)} (${formatPriceTRY(best.newPrice)})`;
            showToast(title.toLowerCase(), msg);
            sendDesktopNotification(title, msg);
        }

        // Tarihçe render
        elHistoryList.innerHTML = "";
        state.meta.history.forEach(entry => {
            const item = document.createElement("div");
            item.className = "history-item";

            const mainRow = document.createElement("div");
            mainRow.className = "history-main";
            mainRow.innerHTML = `
                <span>${entry.platform} / ${entry.name}</span>
                <span>${formatDiscount(entry.discountPercent)}</span>
            `;

            const metaRow = document.createElement("div");
            metaRow.className = "history-meta";
            metaRow.innerHTML = `
                <span>${formatTime(entry.time)}</span>
                <span>${formatPriceTRY(entry.price)}</span>
            `;

            item.appendChild(mainRow);
            item.appendChild(metaRow);
            elHistoryList.appendChild(item);
        });
    }

    // =========================================================
    // Ana tarama fonksiyonu
    // =========================================================

    async function runScan() {
        log("info", "Tarama başlatılıyor...");

        // Status: online
        elStatusDot.classList.remove("offline");
        elStatusDot.classList.add("online");
        elStatusText.textContent = "TARANIYOR";

        const enabledSteam = state.settings.platformSteam;
        const enabledEpic = state.settings.platformEpic;

        const promises = [];
        if (enabledSteam) promises.push(fetchSteamDeals());
        if (enabledEpic) promises.push(fetchEpicDeals());

        let steamDeals = [];
        let epicDeals = [];

        try {
            const results = await Promise.all(promises);

            let index = 0;
            if (enabledSteam) {
                steamDeals = results[index++] || [];
            }
            if (enabledEpic) {
                epicDeals = results[index++] || [];
            }

            // Filtre: minimum indirim
            const minDiscount = state.settings.minDiscount;
            if (enabledSteam) {
                steamDeals = steamDeals.filter(d => d.discountPercent >= minDiscount);
            }
            if (enabledEpic) {
                epicDeals = epicDeals.filter(d => d.discountPercent >= minDiscount);
            }

            state.data.steamDeals = steamDeals;
            state.data.epicDeals = epicDeals;

            // UI güncelle
            const all = [...steamDeals, ...epicDeals];
            const best = all.slice().sort((a, b) => b.discountPercent - a.discountPercent)[0];
            const topId = best ? best.id : null;

            if (enabledSteam) {
                renderDealList(elSteamList, steamDeals, topId);
                elSteamCount.textContent = `${steamDeals.length} oyun`;
                const maxSteam = steamDeals.length
                    ? Math.max(...steamDeals.map(d => d.discountPercent))
                    : 0;
                elSteamMetaExtra.textContent = maxSteam ? `en yüksek: ${formatDiscount(maxSteam)}` : "en yüksek: -";
            } else {
                elSteamList.innerHTML = "";
                elSteamCount.textContent = "devre dışı";
                elSteamMetaExtra.textContent = "—";
            }

            if (enabledEpic) {
                renderDealList(elEpicList, epicDeals, topId);
                elEpicCount.textContent = `${epicDeals.length} oyun`;
                const maxEpic = epicDeals.length
                    ? Math.max(...epicDeals.map(d => d.discountPercent))
                    : 0;
                elEpicMetaExtra.textContent = maxEpic ? `en yüksek: ${formatDiscount(maxEpic)}` : "en yüksek: -";
            } else {
                elEpicList.innerHTML = "";
                elEpicCount.textContent = "devre dışı";
                elEpicMetaExtra.textContent = "—";
            }

            // Özet & tarihçe
            updateSummaryAndHistory();

            // Meta
            const now = new Date();
            state.meta.lastUpdate = now;
            state.meta.scanCount += 1;
            elLastUpdate.textContent = formatTime(now);
            elScanCount.textContent = `${state.meta.scanCount} tarama`;

            // Status
            elStatusText.textContent = "AKTİF";
            log("info", "Tarama tamamlandı.");
        } catch (err) {
            log("error", "Tarama hatası:", err);
            elStatusDot.classList.remove("online");
            elStatusDot.classList.add("offline");
            elStatusText.textContent = "HATA";

            showToast("tarama hatası", "Veri çekerken bir sorun oluştu. Konsola bak.");
        }
    }

    // =========================================================
    // Ayar değişiklikleri
    // =========================================================

    function applySettingsFromUI() {
        state.settings.platformSteam = elToggleSteam.classList.contains("active");
        state.settings.platformEpic = elToggleEpic.classList.contains("active");
        state.settings.minDiscount = Number(elMinDiscountSlider.value);
        state.settings.refreshIntervalSec = Number(elRefreshIntervalSlider.value);

        elMinDiscountLabel.textContent = `En az: ${state.settings.minDiscount}%`;
        elRefreshIntervalLabel.textContent = `${state.settings.refreshIntervalSec} sn`;

        // Otomatik tarama intervalini yeniden ayarla
        if (state.timers.refreshIntervalId) {
            clearInterval(state.timers.refreshIntervalId);
        }

        if (state.settings.refreshIntervalSec > 0) {
            state.timers.refreshIntervalId = setInterval(() => {
                runScan();
            }, state.settings.refreshIntervalSec * 1000);
        }

        log("info", "Ayarlar uygulandı:", JSON.stringify(state.settings));
    }

    // =========================================================
    // Event listener'lar
    // =========================================================

    function setupEventListeners() {
        // Toggle Steam
        elToggleSteam.addEventListener("click", () => {
            elToggleSteam.classList.toggle("active");
            applySettingsFromUI();
            runScan();
        });

        // Toggle Epic
        elToggleEpic.addEventListener("click", () => {
            elToggleEpic.classList.toggle("active");
            applySettingsFromUI();
            runScan();
        });

        // Min indirim slider
        elMinDiscountSlider.addEventListener("input", () => {
            applySettingsFromUI();
            runScan();
        });

        // Yenileme aralığı slider
        elRefreshIntervalSlider.addEventListener("input", () => {
            applySettingsFromUI();
        });

        elRefreshIntervalSlider.addEventListener("change", () => {
            applySettingsFromUI();
        });

        // Manuel tara
        elBtnRefreshNow.addEventListener("click", () => {
            runScan();
        });
    }

    // =========================================================
    // Başlatma
    // =========================================================

    function init() {
        log("info", "İndirim Radarı başlatılıyor...");

        ensureNotificationPermission();
        applySettingsFromUI();
        setupEventListeners();
        runScan();
    }

    document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
